

# תוכנית: אינטגרציה עם חשבונית ירוקה (Morning) - הצעת מחיר עם מע"מ

## סקירה

יצירת הצעות מחיר אוטומטיות מעמוד הלידים, כולל:
- מחירים **לפני מע"מ** - Morning יוסיף את המע"מ אוטומטית
- **סוג הקראוון** (פיצה/בשר/קפה) יופיע כשורה עם מחיר 0 - רק לתיאור
- **גודל הטראק** ו**הציוד** יופיעו עם המחירים הרלוונטיים מהמחירון
- שמירת פרטי ההצעה בליד + קישור להורדת PDF

---

## מבנה הצעת המחיר ב-Morning

```text
+--------------------------------------------------+
|              הצעת מחיר                           |
+--------------------------------------------------+
| לקוח: ישראל ישראלי                               |
| טלפון: 050-1234567                               |
| מייל: israel@example.com                         |
+--------------------------------------------------+
| # | תיאור                    | כמות | מחיר | סה"כ |
|---|--------------------------|------|------|------|
| 1 | פיצה טראק                |  1   |  0   |   0  |  <-- סוג בלבד
| 2 | גודל בינוני (3x2 מטר)    |  1   |50,000| 50,000|
| 3 | תנור פיצה תעשייתי        |  1   | 5,000|  5,000|
| 4 | מקרר 28 ליטר             |  1   | 2,000|  2,000|
+--------------------------------------------------+
| סה"כ לפני מע"מ:                         57,000 ₪ |
| מע"מ (17%):                              9,690 ₪ |
| סה"כ כולל מע"מ:                         66,690 ₪ |
+--------------------------------------------------+
```

---

## סוגי מע"מ ב-API

לפי התיעוד של Morning, ישנם מספר סוגי vatType:

| ערך | משמעות |
|-----|--------|
| 0 | כולל מע"מ (INCLUDED) |
| 1 | לא כולל מע"מ - **יתווסף על המחיר** |
| 2 | פטור ממע"מ |

**נשתמש ב-vatType: 1** - כלומר המחירים שנשלח הם לפני מע"מ, ו-Morning יוסיף את המע"מ בחישוב הסופי.

---

## שלבי המימוש

### שלב 1: הגדרת Secrets

יש להזין את מפתחות ה-API של חשבונית ירוקה:
- `GREEN_INVOICE_API_KEY_ID`
- `GREEN_INVOICE_API_KEY_SECRET`

### שלב 2: Migration לטבלת leads

הוספת עמודות לשמירת פרטי ההצעה:

```text
quote_id         (text)      - מזהה המסמך ב-Morning
quote_number     (text)      - מספר ההצעה
quote_sent_at    (timestamp) - תאריך שליחה
quote_total      (numeric)   - סכום כולל (לפני מע"מ)
quote_url        (text)      - קישור להורדת PDF
```

### שלב 3: Edge Function - create-price-quote

פונקציה חדשה שתבצע:

1. **קבלת נתונים**: leadId מה-request
2. **שליפה מה-DB**: 
   - פרטי הליד (שם, טלפון, מייל)
   - סוג הטראק, גודל, ציוד שנבחר
   - מחירי מכירה מטבלת pricing
3. **אימות מול Morning API**:
   - POST ל-`/account/token` עם API Key
   - קבלת JWT לשימוש בבקשות הבאות
4. **בניית מסמך הצעת מחיר**:
   - type: 10 (הצעת מחיר)
   - vatType: 1 (מחירים לפני מע"מ)
   - שורות income לפי הפירוט למטה
5. **שליחה ללקוח**: במייל אם יש כתובת מייל
6. **עדכון הליד**: שמירת quote_id, quote_url וכו'
7. **החזרת תוצאה**: URL להצעה + מספר ההצעה

### מבנה שורות ה-income

```text
[
  {
    "description": "פיצה טראק",        // סוג הקראוון
    "quantity": 1,
    "price": 0,                        // מחיר 0 - רק תיאור
    "vatType": 1
  },
  {
    "description": "גודל בינוני - 3x2 מטר",
    "quantity": 1,
    "price": 50000,                    // מחיר לפני מע"מ
    "vatType": 1
  },
  {
    "description": "תנור פיצה תעשייתי",
    "quantity": 1,
    "price": 5000,                     // מחיר לפני מע"מ
    "vatType": 1
  },
  ...
]
```

### שלב 4: עדכון UI - LeadsManagement.tsx

בדיאלוג פרטי הליד יתווספו:

1. **סיכום מחירים מחושב**:
   - גודל טראק: XX,XXX ₪
   - ציוד (X פריטים): XX,XXX ₪
   - סה"כ לפני מע"מ: XX,XXX ₪
   - מע"מ (17%): X,XXX ₪
   - **סה"כ: XX,XXX ₪**

2. **כפתור "שלח הצעת מחיר"**:
   - מופיע רק אם יש טראק/ציוד שנבחר
   - בעת לחיצה - קורא ל-Edge Function
   - מציג loading state

3. **סטטוס הצעה** (אם נשלחה):
   - תאריך שליחה
   - מספר הצעה
   - קישור להורדת PDF
   - כפתור "שלח שוב"

---

## תהליך הזרמת הנתונים

```text
+-------------------+
|   לחיצה על       |
|   "שלח הצעה"     |
+--------+----------+
         |
         v
+-------------------+
|   Edge Function   |
|   create-price-   |
|   quote           |
+--------+----------+
         |
    +----+----+
    |         |
    v         v
+-------+  +----------+
| Morning|  | Supabase |
| API    |  | DB       |
+--------+  +----------+
    |            |
    | doc_id     | quote_id
    | url        | quote_url
    | number     | status='quoted'
    +------+-----+
           |
           v
+-------------------+
| Response:         |
| - success: true   |
| - quote_url       |
| - quote_number    |
+--------+----------+
         |
         v
+-------------------+
| invalidateQueries |
| UI מתעדכן         |
+-------------------+
```

---

## קבצים שייווצרו/יעודכנו

| קובץ | פעולה | תיאור |
|------|--------|-------|
| `supabase/functions/create-price-quote/index.ts` | יצירה | Edge Function לשליחת הצעה |
| `supabase/config.toml` | עדכון | הוספת הגדרת הפונקציה |
| Migration SQL | יצירה | עמודות quote בטבלת leads |
| `src/pages/admin/LeadsManagement.tsx` | עדכון | כפתור + mutation + תצוגת מחירים |
| `src/hooks/usePricing.ts` | עדכון | פונקציה לחישוב סכום הצעה |

---

## דרישות טכניות

### מבנה ה-Request ל-Morning (יצירת מסמך)

```text
POST https://api.greeninvoice.co.il/api/v1/documents
Headers:
  Authorization: Bearer {JWT}
  Content-Type: application/json

Body:
{
  "type": 10,                           // הצעת מחיר
  "lang": "he",                         // עברית
  "currency": "ILS",                    // שקלים
  "vatType": 1,                         // מחירים לפני מע"מ
  "client": {
    "name": "שם הלקוח",
    "phone": "050-1234567",
    "emails": ["email@example.com"],
    "add": false                        // לא להוסיף ללקוחות
  },
  "income": [
    { "description": "...", "quantity": 1, "price": 0, "vatType": 1 },
    { "description": "...", "quantity": 1, "price": 50000, "vatType": 1 }
  ],
  "remarks": "הערות נוספות מהליד"
}
```

### Response מ-Morning

```text
{
  "id": "abc123",                       // מזהה המסמך
  "number": 1001,                       // מספר ההצעה
  "amount": 57000,                      // סכום לפני מע"מ
  "amountTotal": 66690,                 // סכום כולל מע"מ
  "url": {
    "origin": "https://...",            // קישור לצפייה
    "he": "https://..."
  }
}
```

---

## הערות חשובות

1. **מחירים לפני מע"מ**: כל המחירים בטבלת pricing הם לפני מע"מ. Morning יוסיף את המע"מ.

2. **סוג הקראוון במחיר 0**: יופיע בתחילת ההצעה כשורה תיאורית בלבד.

3. **Token validity**: ה-JWT תקף לשעה. הפונקציה תבקש token חדש בכל קריאה.

4. **Rate Limit**: כ-3 בקשות בשנייה - מספיק לשימוש הנוכחי.

5. **Sandbox לבדיקות**: ניתן להתחיל עם סביבת Sandbox לבדיקות לפני Production.

---

## דרישות ממך לפני התחלת מימוש

1. **מפתחות API** מחשבונית ירוקה:
   - היכנס לחשבון → הגדרות → מפתחות API → צור מפתח חדש
   - העתק את ה-ID והסוד

2. **מנוי "Best" ומעלה** בחשבונית ירוקה (נדרש לגישה ל-API)

