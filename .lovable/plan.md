
# תוכנית: תהליך הצעת מחיר ב-3 שלבים + תיקון מחירים

## סקירת הבעיות שנמצאו

### בעיה 1: שמות ציוד לא תואמים
```text
בליד: "ציפסר גז (28 ליטר)"
בטבלה: name="ציפסר גז" + description="28 ליטר"
```
הקוד עושה השוואה מדויקת ולא מוצא התאמה.

### בעיה 2: גודל טראק לא נכון
```text
יש 3 גדלים "M" - אחד לכל סוג טראק
הקוד לוקח את הראשון (קפה טראק) גם אם הליד הוא של בשר טראק
```

### בעיה 3: מבנה ההצעה
```text
נוכחי:                           מבוקש:
─────────────────────            ─────────────────────
קפה טראק         ₪0              קפה טראק      ₪56,500
M                ₪50,000          ────────────────────
ציפסר גז         ₪0               פירוט החבילה:
מקרר             ₪0               M - 2.8x1.8       ₪0
                                  ציפסר גז (28 ל')   ₪0
                                  מקרר שתייה        ₪0
```

---

## המבנה החדש

### שלב 1: יצירת הצעה (בלי שליחה)
- כפתור "צור הצעת מחיר"
- יוצר במורנינג עם `sendEmail: false`
- שומר `quote_id`, `quote_url`, `quote_created_at`
- **לא** משנה סטטוס ל-"quoted"

### שלב 2: צפייה
- לינק לפתיחת PDF במורנינג
- אפשרות ליצור מחדש (מוחק ויוצר הצעה חדשה)

### שלב 3: שליחה ללקוח
- כפתור "שלח ללקוח" (נפרד)
- Edge Function חדשה לשליחת מייל
- עדכון `quote_sent_at` ו-`status = 'quoted'`

---

## שינויים טכניים

### 1. Migration - עמודה חדשה
```sql
ALTER TABLE leads ADD COLUMN quote_created_at TIMESTAMPTZ;
```

### 2. עדכון Edge Function: create-price-quote

**תיקון התאמת ציוד:**
```javascript
// במקום השוואה מדויקת:
equipment.find(e => e.name === "ציפסר גז (28 ליטר)")  // לא עובד!

// חיפוש גמיש:
equipment.find(e => selectedName.startsWith(e.name))  // עובד!
```

**תיקון התאמת גודל טראק:**
```javascript
// למצוא קודם את ה-truck_type_id לפי שם הסוג
const truckType = truckTypes.find(t => 
  t.name_he === lead.selected_truck_type
);

// ואז למצוא את הגודל עם אותו truck_type_id
const size = truckSizes.find(s => 
  s.name === lead.selected_truck_size && 
  s.truck_type_id === truckType.id
);
```

**מבנה income חדש:**
```javascript
// שלב 1: חישוב סכום כולל קודם
let totalBeforeVat = sizePrice + equipmentTotal;

// שלב 2: בניית מערך השורות
const incomeItems = [
  // שורה 1: סוג הטראק עם הסכום המלא
  { description: "קפה טראק", price: totalBeforeVat, ... },
  
  // שורה 2: כותרת פירוט
  { description: "פירוט החבילה:", price: 0, ... },
  
  // שורות 3+: הפריטים במחיר 0
  { description: "M - 2.8x1.8 מטר", price: 0, ... },
  { description: "ציפסר גז (28 ליטר)", price: 0, ... },
  ...
];
```

**הפרדה בין יצירה לשליחה:**
```javascript
if (sendEmail) {
  client.emails = [lead.email];
  // עדכון quote_sent_at + status='quoted'
} else {
  // עדכון quote_created_at בלבד, בלי שינוי סטטוס
}
```

### 3. Edge Function חדשה: send-quote-to-client

```javascript
// מקבל: leadId
// פעולות:
// 1. שליפת פרטי הליד (email, quote_url)
// 2. שליחת מייל עם Resend
// 3. עדכון quote_sent_at + status='quoted'
```

### 4. עדכון UI: LeadsManagement.tsx

**מצב 1: אין הצעה**
```text
┌──────────────────────────┐
│     צור הצעת מחיר       │
└──────────────────────────┘
```

**מצב 2: יש הצעה, לא נשלחה**
```text
✅ הצעה #1001 נוצרה ב-04/02/2026
סכום: ₪53,800 (לפני מע"מ)

┌─────────┐  ┌───────────┐  ┌─────────────┐
│ צפה ב-PDF│  │ צור מחדש │  │ שלח ללקוח │
└─────────┘  └───────────┘  └─────────────┘
```

**מצב 3: הצעה נשלחה**
```text
✅ הצעה #1001 נשלחה ב-04/02/2026 16:30
סכום: ₪53,800 (לפני מע"מ)

┌─────────┐  ┌───────────┐
│ צפה ב-PDF│  │ שלח שוב │
└─────────┘  └───────────┘
```

### 5. עדכון QuoteSummary.tsx

תיקון אותה בעיית התאמה כמו ב-Edge Function:
- חיפוש גמיש לציוד
- התאמת גודל לפי סוג הטראק

---

## קבצים שייווצרו/יעודכנו

| קובץ | פעולה |
|------|--------|
| SQL Migration | יצירה - הוספת `quote_created_at` |
| `supabase/functions/create-price-quote/index.ts` | עדכון - תיקון התאמות + מבנה חדש + הפרדה |
| `supabase/functions/send-quote-to-client/index.ts` | יצירה - שליחת מייל |
| `supabase/config.toml` | עדכון - הוספת הפונקציה החדשה |
| `src/pages/admin/LeadsManagement.tsx` | עדכון - mutations חדשות + כפתורים |
| `src/components/admin/QuoteStatus.tsx` | עדכון - הצגת 2 מצבים (נוצר/נשלח) |
| `src/components/admin/QuoteSummary.tsx` | עדכון - תיקון התאמת מחירים |

---

## זרימת הנתונים

```text
┌───────────────────────────────────────────────────────────────┐
│                        יצירת הצעה                            │
├───────────────────────────────────────────────────────────────┤
│  לחיצה על "צור הצעת מחיר"                                     │
│           ↓                                                   │
│  create-price-quote (sendEmail=false)                         │
│           ↓                                                   │
│  ┌─────────────────────────────────────────────┐              │
│  │ 1. שליפת ליד + מחירים                       │              │
│  │ 2. התאמה גמישה (startsWith לציוד)            │              │
│  │ 3. התאמה לפי truck_type_id לגודל            │              │
│  │ 4. חישוב סכום כולל                          │              │
│  │ 5. בניית income: סוג=מחיר מלא, שאר=0        │              │
│  │ 6. שליחה למורנינג (בלי מייל)                │              │
│  │ 7. עדכון leads: quote_created_at            │              │
│  └─────────────────────────────────────────────┘              │
│           ↓                                                   │
│  UI מציג: צפה | צור מחדש | שלח ללקוח                          │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│                        שליחה ללקוח                           │
├───────────────────────────────────────────────────────────────┤
│  לחיצה על "שלח ללקוח"                                         │
│           ↓                                                   │
│  send-quote-to-client                                         │
│           ↓                                                   │
│  ┌─────────────────────────────────────────────┐              │
│  │ 1. שליפת ליד (email, quote_url, full_name)  │              │
│  │ 2. שליחת מייל עם Resend                     │              │
│  │ 3. עדכון leads: quote_sent_at, status       │              │
│  └─────────────────────────────────────────────┘              │
│           ↓                                                   │
│  UI מציג: צפה | שלח שוב                                       │
└───────────────────────────────────────────────────────────────┘
```

---

## דוגמה להצעה אחרי התיקון

**נתוני הליד:**
- סוג: קפה טראק
- גודל: M
- ציוד: ציפסר גז (28 ליטר), מקרר שתייה (400 ליטר), שולחן דלפקי

**מחירים מהמחירון:**
- M (קפה טראק): ₪50,000
- ציפסר גז: ₪2,000
- מקרר שתייה: ₪1,000
- שולחן דלפקי: ₪800

**ההצעה במורנינג:**

| תיאור | כמות | מחיר |
|-------|------|------|
| קפה טראק | 1 | ₪53,800 |
| פירוט החבילה: | 1 | ₪0 |
| M - 2.8x1.8 מטר | 1 | ₪0 |
| ציפסר גז (28 ליטר) | 1 | ₪0 |
| מקרר שתייה (400 ליטר) | 1 | ₪0 |
| שולחן דלפקי (1×0.6 מטר) | 1 | ₪0 |

**סיכום:**
- סה"כ לפני מע"מ: ₪53,800
- מע"מ (17%): ₪9,146
- סה"כ: ₪62,946
